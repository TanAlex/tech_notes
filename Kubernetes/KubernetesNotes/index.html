<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Kubernetes - Tech Notes</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Kubernetes";
    var mkdocs_page_input_path = "Kubernetes\\KubernetesNotes.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Tech Notes</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Powershell</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../Powershell/">Powershell Note</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Powershell/Module/">PS Modules Note</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Powershell/Functions/">PS Functions Note</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Powershell/Snippets/">PS Snippets</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../DockerSwarm/">DockerSwarm</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Kubernetes</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#notes">Notes</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#ingress">Ingress</a></li>
        
            <li><a class="toctree-l3" href="#use-traefik-for-ingress">Use Traefik for Ingress</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Tech Notes</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
    
    <li>Kubernetes</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="notes">Notes</h1>
<!-- TOC -->

<ul>
<li><a href="#notes">Notes</a><ul>
<li><a href="#ingress">Ingress</a></li>
<li><a href="#use-traefik-for-ingress">Use Traefik for Ingress</a><ul>
<li><a href="#create-rbac">Create RBAC</a><ul>
<li><a href="#first-create-a-new-serviceaccount-to-provide-traefik-with-the-identity-in-your-cluster">First create a new ServiceAccount to provide Traefik with the identity in your cluster.</a></li>
<li><a href="#next-lets-create-a-clusterrole-with-a-set-of-permissions">Next, let’s create a <code>ClusterRole</code> with a set of permissions</a></li>
<li><a href="#finally-to-enable-these-permissions-we-should-bind-the-clusterrole-to-the-traefik-serviceaccount">Finally, to enable these permissions, we should bind the ClusterRole to the Traefik ServiceAccount.</a></li>
</ul>
</li>
<li><a href="#deploy-traefik-to-a-cluster">Deploy Traefik to a Cluster</a></li>
<li><a href="#create-service-to-use-traefik-ui-on-port-8080">Create service to use Traefik UI on port 8080</a></li>
<li><a href="#create-a-ingress-service-for-traefik-web-ui">Create a Ingress service for Traefik Web UI</a></li>
<li><a href="#create-nodeport-just-to-allow-access-from-node">Create NodePort just to allow access from node</a></li>
<li><a href="#setup-ingress-service-to-do-weight-loadbalancing">Setup Ingress service to do weight loadbalancing</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->

<h2 id="ingress">Ingress</h2>
<p><a href="https://medium.com/kubernetes-tutorials/deploying-traefik-as-ingress-controller-for-your-kubernetes-cluster-b03a0672ae0c">Reference</a></p>
<p>Simple Ingress service  </p>
<p>This will route all traffic to the deaultbackend service</p>
<pre><code class="yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: test-ingress
spec:
  backend:
    serviceName: defaultbackend
    servicePort: 80
</code></pre>

<p>The following does a rewrite using annotation<br />
it also only redirect /microservice1 to the backend service called <code>test</code></p>
<pre><code class="yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-example
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - http:
      paths:
      - path: /microservice1
        backend:
          serviceName: test
          servicePort: 80
</code></pre>

<h2 id="use-traefik-for-ingress">Use Traefik for Ingress</h2>
<h3 id="create-rbac">Create RBAC</h3>
<h4 id="first-create-a-new-serviceaccount-to-provide-traefik-with-the-identity-in-your-cluster">First create a new ServiceAccount to provide Traefik with the identity in your cluster.</h4>
<pre><code class="yml">apiVersion: v1
kind: ServiceAccount
metadata:
  name: traefik-ingress
  namespace: kube-system
To create the ServiceAccount, save the manifest above in the traefik-service-acc.yaml and run:
</code></pre>

<p>Run kubectl</p>
<pre><code>kubectl create -f traefik-service-acc.yaml
serviceaccount &quot;traefik-ingress&quot; created
</code></pre>

<h4 id="next-lets-create-a-clusterrole-with-a-set-of-permissions">Next, let’s create a <code>ClusterRole</code> with a set of permissions</h4>
<p>which will be applied to the Traefik ServiceAccount. The ClusterRole will allow Traefik to manage and watch such resources as Services, Endpoints, Secrets, and Ingresses across all namespaces in your cluster.</p>
<pre><code class="yml">kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: traefik-ingress
rules:
  - apiGroups:
      - &quot;&quot;
    resources:
      - services
      - endpoints
      - secrets
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - extensions
    resources:
      - ingresses
    verbs:
      - get
      - list
      - watch
</code></pre>

<p>Save this spec to the file traefik-cr.yaml and run:</p>
<pre><code>kubectl create -f traefik-cr.yaml
clusterrole.rbac.authorization.k8s.io “traefik-ingress” created
</code></pre>

<h4 id="finally-to-enable-these-permissions-we-should-bind-the-clusterrole-to-the-traefik-serviceaccount">Finally, to enable these permissions, we should bind the ClusterRole to the Traefik ServiceAccount.</h4>
<p>This can be done using the ClusterRoleBinding manifest:</p>
<pre><code class="yml">kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: traefik-ingress
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: traefik-ingress
subjects:
- kind: ServiceAccount
  name: traefik-ingress
  namespace: kube-system
</code></pre>

<p>Save this spec to the traefik-crb.yaml and run the following command:</p>
<pre><code>kubectl create -f traefik-crb.yaml
clusterrolebinding.rbac.authorization.k8s.io “traefik-ingress” created
</code></pre>

<h3 id="deploy-traefik-to-a-cluster">Deploy Traefik to a Cluster</h3>
<p>Deployment manifest:</p>
<pre><code class="yml">kind: Deployment
apiVersion: extensions/v1beta1
metadata:
  name: traefik-ingress
  namespace: kube-system
  labels:
    k8s-app: traefik-ingress-lb
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: traefik-ingress-lb
  template:
    metadata:
      labels:
        k8s-app: traefik-ingress-lb
        name: traefik-ingress-lb
    spec:
      serviceAccountName: traefik-ingress
      terminationGracePeriodSeconds: 60
      containers:
      - image: traefik
        name: traefik-ingress-lb
        ports:
        - name: http
          containerPort: 80
        - name: admin
          containerPort: 8080
        args:
        - --api
        - --kubernetes
        - --logLevel=INFO
</code></pre>

<p>Save this manifest to the traefik-deployment.yaml file and create the Deployment running the following command:</p>
<pre><code>kubectl create -f traefik-deployment.yaml
deployment.extensions “traefik-ingress” created
</code></pre>

<p>Now, let’s check to see if the Traefik Pods were successfully created:</p>
<pre><code>kubectl --namespace=kube-system get pods
NAME                         READY     STATUS    RESTARTS   AGE
....
storage-provisioner           1/1       Running   3          23d
traefik-ingress-54d6d8d9cc-ls6cs 1/1       Running   0          1m
</code></pre>

<h3 id="create-service-to-use-traefik-ui-on-port-8080">Create service to use Traefik UI on port 8080</h3>
<pre><code class="yml">apiVersion: v1
kind: Service
metadata:
  name: traefik-web-ui
  namespace: kube-system
spec:
  selector:
    k8s-app: traefik-ingress-lb
  ports:
  - name: web
    port: 80
    targetPort: 8080
</code></pre>

<p>Save this manifest to traefik-webui-svc.yaml and run:</p>
<pre><code>kubectl create -f traefik-webui-svc.yaml
service “traefik-web-ui” created
</code></pre>

<p>Let’s verify that the Service was created:</p>
<pre><code>kubectl describe svc traefik-web-ui --namespace=kube-system
Name:              traefik-web-ui
Namespace:         kube-system
Labels:            &lt;none&gt;
Annotations:       &lt;none&gt;
Selector:          k8s-app=traefik-ingress-lb
Type:              ClusterIP
IP:                10.98.230.58
Port:              web  80/TCP
TargetPort:        8080/TCP
Endpoints:         172.17.0.6:8080
Session Affinity:  None
Events:            &lt;none&gt;
</code></pre>

<h3 id="create-a-ingress-service-for-traefik-web-ui">Create a Ingress service for Traefik Web UI</h3>
<p>We need to create an Ingress resource pointing to the Traefik Web UI backend.<br />
that only direct traffic when the host is traefik-ui.minikube</p>
<pre><code class="yml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: traefik-web-ui
  namespace: kube-system
spec:
  rules:
  - host: traefik-ui.minikube
    http:
      paths:
      - path: /
        backend:
          serviceName: traefik-web-ui
          servicePort: web
</code></pre>

<p>In essence, this Ingress routes all requests to traefik-ui.minikube host to the Traefik Web UI exposed by the Service created in the step above.</p>
<p>Save the spec to the traefik-ingress.yaml and run:</p>
<pre><code>kubectl create -f traefik-ingress.yaml
ingress.extensions “traefik-web-ui” created
</code></pre>

<h3 id="create-nodeport-just-to-allow-access-from-node">Create NodePort just to allow access from node</h3>
<pre><code class="yml">kind: Service
apiVersion: v1
metadata:
  name: traefik-ingress-service
  namespace: kube-system
spec:
  selector:
    k8s-app: traefik-ingress-lb
  ports:
    - protocol: TCP
      port: 80
      name: web
    - protocol: TCP
      port: 8080
      name: admin
  type: NodePort
</code></pre>

<p>Save this manifest to traefik-svc.yaml and create the Service:</p>
<pre><code>kubectl create -f traefik-svc.yaml
service “traefik-ingress-service” created
</code></pre>

<p>Check the NodePort </p>
<pre><code>kubectl describe svc traefik-ingress-service --namespace=kube-system
Name:                     traefik-ingress-service
Namespace:                kube-system
Labels:                   &lt;none&gt;
Annotations:              &lt;none&gt;
Selector:                 k8s-app=traefik-ingress-lb
Type:                     NodePort
IP:                       10.102.215.64
Port:                     web  80/TCP
TargetPort:               80/TCP
NodePort:                 web  30565/TCP
Endpoints:                172.17.0.6:80
Port:                     admin  8080/TCP
TargetPort:               8080/TCP
NodePort:                 admin  30729/TCP
Endpoints:                172.17.0.6:8080
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   &lt;none&gt;
</code></pre>

<p>You can then access the endpoint using</p>
<pre><code> http://traefik-ui.minikube/&lt;NodePort&gt;
 In this case, NodePort is 30729
</code></pre>

<h3 id="setup-ingress-service-to-do-weight-loadbalancing">Setup Ingress service to do weight loadbalancing</h3>
<pre><code class="yml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    traefik.ingress.kubernetes.io/service-weights: |
      animals-app: 99%
      animals-app-canary: 1%
  name: animals-app
spec:
  rules:
  - http:
      paths:
      - backend:
          serviceName: animals-app
          servicePort: 80
        path: /
      - backend:
          serviceName: animals-app-canary
          servicePort: 80
        path: /
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../../DockerSwarm/" class="btn btn-neutral" title="DockerSwarm"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../../DockerSwarm/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>
