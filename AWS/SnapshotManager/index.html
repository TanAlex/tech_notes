<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Snapshot manager - Tech Notes</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Snapshot manager";
    var mkdocs_page_input_path = "AWS/SnapshotManager.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Tech Notes</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Powershell</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../Powershell/">Powershell Note</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Powershell/Module/">PS Modules Note</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Powershell/Functions/">PS Functions Note</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../DockerSwarm/">DockerSwarm</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../Kubernetes/KubernetesNotes/">Kubernetes</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../Sites/">Sites</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">AWS</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../CloudFormation/">CloudFormation</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Snapshot manager</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#snapshot-manager-note">Snapshot Manager Note</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#overview-of-the-problem-we-want-to-solve">Overview of the problem we want to solve</a></li>
        
            <li><a class="toctree-l4" href="#simplify-the-problem-first">Simplify the problem first</a></li>
        
            <li><a class="toctree-l4" href="#next-step-use-this-algorithm-in-the-snapshot-management-program">Next step, use this algorithm in the snapshot management program</a></li>
        
        </ul>
    

    </ul>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Tech Notes</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>AWS &raquo;</li>
        
      
    
    <li>Snapshot manager</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="snapshot-manager-note">Snapshot Manager Note</h1>
<h2 id="overview-of-the-problem-we-want-to-solve">Overview of the problem we want to solve</h2>
<p>In dailly AWS operations, we need to make snapshot and copy them to another region for backup purpose.<br />
This is not a new problem and there are many existing solutions.  </p>
<p>The interesting part is how can we keep the snapshots efficiently.<br />
For example, if those snapshots were made every 30 minutes, you will have 48 snapshots in a day and 480 snapshots in 10 days.  </p>
<p>In previous solutions, they just simply setup a policy to remove those old snapshots by a fixed number or date.<br />
The problem is if you set to keep 30 snapshots, it will only keep less than a days backup and if you set to keep 10 days, you end up wasting a lot of storage to keep these 480 snapshots.  </p>
<p>A much better solution is to have an "Elastic" rule to remove those snapshots based on their create time.<br />
For example, we can set the rule like this:</p>
<ul>
<li>If this snapshot was made in recent 5 hours, then we keep it </li>
<li>If it's between 5h to 12h, we keep only 1 per hour</li>
<li>If it's from 12h to 24h, we only keep one every 4 hours</li>
<li>If it's after 2days, we only keep 1 per day</li>
<li>If it's over 14 days, we don't keep</li>
</ul>
<p>This solution is like the RRDTools db algorithm, we keep the data based on their freshness. Older data will be treated differently than newer data.<br />
This algorithm is what we want to implement here.</p>
<h2 id="simplify-the-problem-first">Simplify the problem first</h2>
<p>Lets try to solve a simplified version first then we can use the knowledge to implement a much complete solution.  </p>
<p>First, we set the data we want to process to a simple array(LIST) with integer from 1 to 50</p>
<pre><code>Data = [i+1  for i in range(50)]
</code></pre>

<p>Then we define our rule to be like this</p>
<pre><code>Rule = {
    &quot;5&quot;: 3,
    &quot;10&quot;: 6,
    &quot;25&quot;: 10,
    &quot;40&quot;: -1
}
</code></pre>

<p>This rule means:</p>
<ul>
<li>If data &gt;= 5, keep one every 3 </li>
<li>If data &gt;=10, keep one every 6</li>
<li>If data &gt;=25, keep one every 10</li>
<li>If data &gt;=40, don't keep</li>
</ul>
<p>Then we sort the Rule's keys </p>
<pre><code>ruleKeys = sorted([ int(v) for v in rule.keys() ])
</code></pre>

<p>now <code>ruleKeys</code> is like [5, 10, 25, 40]</p>
<p>for any given data as <code>d</code>, we will check which range it fits in the <code>ruleKeys</code></p>
<p>Here we use <code>bisect.bisect_left</code> to do a quick bisect search</p>
<pre><code>def find_lt(a, x):
    'Find rightmost value less than x'
    i = bisect_left(a, x)
    if i:
        return a[i-1]
    raise ValueError
</code></pre>

<p>For example, if data is 6
<code>k = find_lt(ruleKeys, 6)</code> will give you the <code>rightmost value in ruleKeys less than 6</code> which is 5  </p>
<p>Now we know 6 is in the range of 5 to 10, and based on the <code>Rule</code> dict, we know in that range, we want to keep one every 3</p>
<pre><code>&quot;5&quot;: 3
</code></pre>

<p>We call this 3 <code>interval</code></p>
<pre><code>interval = rule[str(k)]
</code></pre>

<p>Then we can calculate which "bucket" our data 6 will fit in</p>
<pre><code>bucketNumb = (d - k) // interval
</code></pre>

<p>For example, <code>(6 - 5) // 3</code> will give 0 and <code>(8 - 5) // 3</code> will give 1<br />
That means 5, 6, 7 will have same bucket number 0 and 8, 9, 10 will be in bucket 1 and 11, 12, 13 will be in bucket 2<br />
We can just use the bucket number to decide whether we need to keep this data or not<br />
Say we have 5 then there is no need to keep 6 and 7<br />
if we have 12, there is no need to keep 13 because they are in same bucket.</p>
<p>So the ProcessData looks like this</p>
<pre><code>def ProcessData(data, rule):
    ruleKeys = sorted([ int(v) for v in rule.keys() ])
    lastBucket = -1
    lastRuleKey = -1
    for d in data:
        ifRemove = False
        try:
            k = find_le(ruleKeys, d)
            interval = rule[str(k)]
            if interval &lt;= 0:
                ifRemove = True
            else:
                if k == d:
                    lastBucket = 0
                    lastRuleKey = k
                else:
                    bucketNumb = (d - k) // interval
                    if k != lastRuleKey:
                        lastRuleKey = k
                        lastBucket = bucketNumb
                    else:                    
                        if bucketNumb == lastBucket:
                            ifRemove = True
                        else:
                            lastBucket = bucketNumb
        except ValueError:
            # k is less than ruleKeys[0], simply pass so it won't be REMOVED
            pass
        if ifRemove:
            print(&quot;{0:3d}  {1:10s}&quot;.format(d, &quot;REMOVE&quot;))
        else:
            print(&quot;{0:3d}  {1:10s}&quot;.format(d, &quot;OK&quot;))
</code></pre>

<h2 id="next-step-use-this-algorithm-in-the-snapshot-management-program">Next step, use this algorithm in the snapshot management program</h2>
<p>First, we need to set the Rule based on time difference of current time and the creation time of the snapshots</p>
<pre><code># current time in UTC
utc_now = datetime.now(timezone.utc)

# time difference in seconds between &quot;now&quot; and the snapshots create time
int((utc_now - s['StartTime']).total_seconds())
</code></pre>

<p>Next, we need to figure out a way to specify the Rules more intuitively</p>
<p>We'd like the Rule to be readable, something like this:</p>
<pre><code>Rule = {
    &quot;10h&quot;: &quot;20m&quot;,
    &quot;11h10m&quot;: 1800,
    &quot;12h&quot;: &quot;40m&quot;,
    &quot;1d&quot;: &quot;1d&quot;
    &quot;2d&quot;: -1
}
</code></pre>

<p>In the example above, "10h" means 10 hours, 20m means 20 minutes, 1d means 1 day</p>
<p>Here comes a handy utility function to convert these "time string" to regular timedelta</p>
<pre><code>regex = re.compile(r'((?P&lt;days&gt;\d+?)d)?((?P&lt;hours&gt;\d+?)h)?((?P&lt;minutes&gt;\d+?)m)?((?P&lt;seconds&gt;\d+?)s)?')

def timestr_to_seconds(time_str):
    # check if time_str is a numeric value like 1200 or -1
    time_str = str(time_str)
    if re.match(r&quot;^\d+$&quot;, time_str):
        # if it's just an integer, assume it's seconds
        return int(time_str)
    # otherwise try to parse the value using RegEx
    parts = regex.search(time_str)
    if not parts:
        return None
    parts = parts.groupdict()
    time_params = {}
    for (name, param) in parts.items():
        if param:
            time_params[name] = int(param)
    return timedelta(**time_params).total_seconds()
</code></pre>

<p>Finally, we can combine all these to a more complete solution like:</p>
<pre><code>def process_snapshots(rule):
    # Get my AWS Account ID
    myAccount = boto3.client('sts').get_caller_identity()['Account']

    # Connect to EC2
    client = boto3.client('ec2', region_name = 'us-west-2')

    # Get a list of snapshots for my AWS account (not all public ones)
    snapshots = client.describe_snapshots(OwnerIds=[myAccount])['Snapshots']
    print(snapshots)

    # utc_origin = datetime.utcfromtimestamp(0) # this gives 1970.1.1
    # utc_now = datetime.utcnow()
    utc_now = datetime.now(timezone.utc)
    # now_seconds = (utc_now - utc_origin).total_seconds()
    # print(utc_origin, utc_now, now_seconds)

    snapshots_seconds = [ 
        {
            &quot;sec&quot;: int((utc_now - s['StartTime']).total_seconds()),
            &quot;ind&quot;: i
        }
            for i, s in enumerate(snapshots) 
    ]
    # sort this list by the &quot;sec&quot; value, so it will be in asc order
    snapshots_seconds = sorted(snapshots_seconds, key=lambda x: x['sec'])
    print(snapshots_seconds)

    # process snapshots based on rules
    newRule = {}
    for k,v in rule.items():
        rule_key = int(utils.timestr_to_seconds(k))
        rule_val = int(utils.timestr_to_seconds(v))
        newRule[str(rule_key)] = rule_val

    ruleKeys = sorted([ int(v) for v in newRule.keys() ])
    rule = newRule
    lastBucket = -1
    lastRuleKey = -1
    for v in snapshots_seconds:
        d = v['sec']
        i = v['ind']
        ifRemove = False
        try:
            k = find_le(ruleKeys, d)
            interval = rule[str(k)]
            if interval &lt;= 0:
                ifRemove = True
            else:
                if k == d:
                    lastBucket = 0
                    lastRuleKey = k
                else:
                    bucketNumb = (d - k) // interval
                    if k != lastRuleKey:
                        lastRuleKey = k
                        lastBucket = bucketNumb
                    else:
                        if bucketNumb == lastBucket:
                            ifRemove = True
                        else:
                            lastBucket = bucketNumb
        except ValueError:
            # k is less than ruleKeys[0], simply pass so it won't be REMOVED
            pass
        if ifRemove:
            print(&quot;{} sec:{} SnapshotId:{} {:10s}&quot;.format(i, d, snapshots[i]['SnapshotId'], &quot;REMOVE&quot;)) 
        else:
            print(&quot;{} sec:{} SnapshotId:{} {:10s}&quot;.format(i, d, snapshots[i]['SnapshotId'], &quot;OK&quot;))
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../CloudFormation/" class="btn btn-neutral" title="CloudFormation"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../CloudFormation/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>
